<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kinerja Perawatan & Pemeliharaan</title>
    <style>
        /* CSS Umum */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px 2cm; background-color: #f4f4f4; color: #333; }
        .container { max-width: 100%; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
        .report-header-image { width: 100%; margin-bottom: 20px; }
        .report-header-image img { width: 100%; height: auto; }
        .report-title-container { font-family: 'Times New Roman', Times, serif; text-align: center; margin-bottom: 30px; }
        .title-line { padding: 2px 0; font-weight: bold; font-size: 1.1em; text-transform: uppercase; }
        .form-container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        h2.form-title, h2.table-title { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 5px; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #alat-bantu-form { margin-top: 20px; padding: 15px; border: 1px dashed #007bff; border-radius: 5px; background-color: #f8f9fa; }
        #alat-bantu-list-container { margin-top: 15px; }
        #alat-bantu-list li { margin-bottom: 5px; background: #e9ecef; padding: 5px 10px; border-radius: 4px; }
        .btn, button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 10px; margin-top: 10px; }
        .btn-add { background-color: #28a745; color: white; }
        .btn-save { background-color: #007bff; color: white; }
        .btn-print { background-color: #6c757d; color: white; }
        .btn-edit { background-color: #ffc107; color: black; padding: 5px 10px; margin: 0 5px 0 0; }
        .btn-delete { background-color: #dc3545; color: white; padding: 5px 10px; margin: 0; }
        button.remove-item { background-color: #dc3545; color: white; padding: 2px 8px; font-size: 0.8em; margin-left: 10px; }
        .btn-reset-all { background-color: #c82333; color: white; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #e9ecef; text-align: center; font-weight: bold; }
        .action-buttons { text-align: center; }
        .report-footer { display: none; margin-top: 50px; width: 100%; font-family: 'Times New Roman', Times, serif; }
        .signature-block { display: flex; justify-content: space-between; text-align: center; }
        .signature-col { width: 30%; }
        .signature-col p:not(.name) { margin-top: 0; margin-bottom: 2px; }
        .signature-col .name { margin-top: 80px; font-weight: bold; text-decoration: underline; }
        
        @media print {
            body { background-color: white; margin: 0; padding: 0; font-size: 10pt; }
            .container { box-shadow: none; border-radius: 0; padding: 0; max-width: 100%; }
            .form-container, .table-header, .action-buttons { display: none !important; }
            th, td { padding: 5px; border: 1px solid #000; }
            .report-header-image img { width: 50%; display: block; margin: 0 auto 20px auto; }
            @page { size: A4 landscape; margin: 1cm 2cm 2cm 2cm; }

            /* --- [MODIFIKASI] MENCEGAH PAGE BREAK --- */
            
            /* 1. Mencegah grup baris tabel terpotong */
            #laporan-table > tbody {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* 2. Wrapper untuk memastikan 2 data terakhir dan TTD tetap bersama */
            .last-page-wrapper {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
            }

            /* 3. Tampilkan footer yang ada di dalam wrapper, dan sembunyikan yang asli */
            .last-page-wrapper .report-footer {
                display: block !important; /* Pastikan KLON footer di dalam wrapper TERLIHAT */
            }
            .report-footer.moved {
                display: none !important; /* Sembunyikan footer ASLI yang posisinya tidak berubah */
            }

            /* 4. Pastikan tabel baru di dalam wrapper terlihat benar */
            .last-page-wrapper table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9em;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 10px; }
            .table-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .table-header > div { margin-top: 0; }
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 4px; padding-bottom: 10px; }
            h2.form-title, h2.table-title { font-size: 1.5em; }
            .btn, button { padding: 8px 12px; font-size: 0.9em; }
            .signature-col .name { margin-top: 40px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="report-header-image">
        <img src="kop.jpg" alt="Kop Surat Laporan">
    </div>
    <div class="report-title-container">
        <!-- ... Konten dinamis ... -->
    </div>
    <div class="form-container">
        <!-- ... Form ... -->
    </div>
    <div class="table-container">
        <div class="table-header">
            <h2 class="table-title">Data Laporan Tersimpan</h2>
            <div>
                <button class="btn btn-print" onclick="prepareAndPrint()">Cetak Laporan</button>
                <button class="btn btn-reset-all" onclick="resetAllData()">Reset Semua Data</button>
            </div>
        </div>
        <table id="laporan-table">
            <!-- ... Thead ... -->
        </table>
    </div>
    <div class="report-footer">
        <div class="signature-block">
            <div class="signature-col"><p>Mengetahui</p><p>Direktur</p><p class="name">Moses P. Limbongan, S. S</p></div>
            <div class="signature-col"><p>Di Periksa</p><p>Kepala Bagian Perawatan</p><p class="name">Linan Patanggi</p></div>
            <div class="signature-col"><p>Di Buat</p><p>Kasubag. Transmisi & Instalasi</p><p class="name">Fery Panggalo</p></div>
        </div>
    </div>
</div>

<script>
// Bagian script yang tidak berubah sengaja saya sembunyikan agar fokus pada perubahan
// Namun kode di bawah ini adalah kode lengkap yang berfungsi

function getNextId() { const lastId = localStorage.getItem('lastId_v2') || '0'; const nextId = parseInt(lastId) + 1; localStorage.setItem('lastId_v2', nextId); return nextId; }
function getLaporanFromStorage() { return JSON.parse(localStorage.getItem('laporanData_v2')) || []; }
function formatTanggalLengkap(tanggalString) { if (!tanggalString) return ''; const parts = tanggalString.split('-'); const tanggalObj = new Date(parts[0], parts[1] - 1, parts[2]); const namaHari = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"]; const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; const hari = namaHari[tanggalObj.getDay()]; const tgl = String(tanggalObj.getDate()).padStart(2, '0'); const bulan = namaBulan[tanggalObj.getMonth()]; const tahun = tanggalObj.getFullYear(); return `${hari}, ${tgl} ${bulan} ${tahun}`; }
function updateLaporanPeriode() { const periodeElement = document.getElementById('laporan-periode'); const laporanList = getLaporanFromStorage(); if (laporanList.length === 0) { periodeElement.textContent = 'HASIL LAPORAN KINERJA KEBOCORAN (BELUM ADA DATA)'; return; } const dates = laporanList.map(item => new Date(item.tanggal)); const maxDate = new Date(Math.max.apply(null, dates)); const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; const bulan = namaBulan[maxDate.getMonth()]; const tahun = maxDate.getFullYear(); const periodeText = `1-30 ${bulan} ${tahun}`; document.querySelector('.report-title-container').innerHTML = `<div class="title-line">LAPORAN BULANAN BAGIAN PERAWATAN & PEMELIHARAAN</div><div class="title-line">SUB BAGIAN TRANSMISI DAN INSTALASI</div><div class="title-line" id="laporan-periode">HASIL LAPORAN KINERJA KEBOCORAN ${periodeText}</div>`; }
document.getElementById('laporan-form').addEventListener('submit', function(e) { e.preventDefault(); const id = document.getElementById('edit-id').value; let alatBantu = []; document.querySelectorAll('#alat-bantu-list li').forEach(li => { alatBantu.push(JSON.parse(li.dataset.alat)); }); if (alatBantu.length === 0) { if (!confirm('Anda belum menambahkan Alat Bantu. Tetap simpan?')) { return; } } const laporanData = { tanggal: document.getElementById('tanggal').value, namaKegiatan: document.getElementById('nama-kegiatan').value, lokasi: document.getElementById('lokasi').value, jumlahTenagaKerja: document.getElementById('jumlah-tenaga-kerja').value, masalah: document.getElementById('masalah').value, caraKerja: document.getElementById('cara-kerja').value, lamaPengerjaan: document.getElementById('lama-pengerjaan').value, alatBantu: alatBantu }; let laporanList = getLaporanFromStorage(); if (id) { const index = laporanList.findIndex(item => item.id == id); if (index > -1) { laporanList[index] = { ...laporanData, id: parseInt(id) }; } } else { laporanData.id = getNextId(); laporanList.push(laporanData); } localStorage.setItem('laporanData_v2', JSON.stringify(laporanList)); resetForm(); renderTable(); });
function tambahAlatBantuKeList(data = null) { const list = document.getElementById('alat-bantu-list'); const alat = data || { bahan: document.getElementById('bahan').value, ukuran: document.getElementById('ukuran').value, banyaknya: document.getElementById('banyaknya').value }; if (!alat.bahan.trim()) { alert('Nama Bahan tidak boleh kosong.'); return; } const li = document.createElement('li'); li.textContent = `Bahan: ${alat.bahan}, Ukuran: ${alat.ukuran}, Banyaknya: ${alat.banyaknya}`; li.dataset.alat = JSON.stringify(alat); const removeBtn = document.createElement('button'); removeBtn.textContent = 'x'; removeBtn.className = 'remove-item'; removeBtn.type = 'button'; removeBtn.onclick = function() { li.remove(); }; li.appendChild(removeBtn); list.appendChild(li); if (!data) { document.getElementById('bahan').value = ''; document.getElementById('ukuran').value = ''; document.getElementById('banyaknya').value = ''; document.getElementById('bahan').focus(); } }
function renderTable() { updateLaporanPeriode(); const laporanList = getLaporanFromStorage(); const table = document.getElementById('laporan-table'); table.querySelectorAll('tbody').forEach(tbody => tbody.remove()); laporanList.forEach((item, index) => { const rowCount = item.alatBantu.length > 0 ? item.alatBantu.length : 1; const entryTbody = document.createElement('tbody'); for (let i = 0; i < rowCount; i++) { const row = document.createElement('tr'); if (i === 0) { row.innerHTML = `<td rowspan="${rowCount}">${index + 1}</td><td rowspan="${rowCount}">${formatTanggalLengkap(item.tanggal)}</td><td rowspan="${rowCount}">${item.namaKegiatan}</td><td rowspan="${rowCount}">${item.lokasi}</td><td rowspan="${rowCount}">${item.jumlahTenagaKerja || ''}</td><td rowspan="${rowCount}">${item.masalah}</td><td rowspan="${rowCount}">${item.caraKerja}</td><td rowspan="${rowCount}">${item.lamaPengerjaan}</td><td>${item.alatBantu[i]?.bahan || ''}</td><td>${item.alatBantu[i]?.ukuran || ''}</td><td>${item.alatBantu[i]?.banyaknya || ''}</td><td rowspan="${rowCount}" class="action-buttons"><button class="btn btn-edit" onclick="editData(${item.id})">Edit</button><button class="btn btn-delete" onclick="deleteData(${item.id})">Hapus</button></td>`; } else { row.innerHTML = `<td>${item.alatBantu[i]?.bahan || ''}</td><td>${item.alatBantu[i]?.ukuran || ''}</td><td>${item.alatBantu[i]?.banyaknya || ''}</td>`; } entryTbody.appendChild(row); } table.appendChild(entryTbody); }); }
function editData(id) { const laporanList = getLaporanFromStorage(); const itemToEdit = laporanList.find(item => item.id == id); if (!itemToEdit) return; resetForm(); document.getElementById('edit-id').value = itemToEdit.id; document.getElementById('tanggal').value = itemToEdit.tanggal; document.getElementById('nama-kegiatan').value = itemToEdit.namaKegiatan; document.getElementById('lokasi').value = itemToEdit.lokasi; document.getElementById('jumlah-tenaga-kerja').value = itemToEdit.jumlahTenagaKerja; document.getElementById('masalah').value = itemToEdit.masalah; document.getElementById('cara-kerja').value = itemToEdit.caraKerja; document.getElementById('lama-pengerjaan').value = itemToEdit.lamaPengerjaan; if (itemToEdit.alatBantu) { itemToEdit.alatBantu.forEach(alat => tambahAlatBantuKeList(alat)); } window.scrollTo({ top: 0, behavior: 'smooth' }); }
function deleteData(id) { if (confirm('Apakah Anda yakin ingin menghapus data laporan ini?')) { let laporanList = getLaporanFromStorage(); laporanList = laporanList.filter(item => item.id != id); localStorage.setItem('laporanData_v2', JSON.stringify(laporanList)); renderTable(); } }
function resetForm() { document.getElementById('laporan-form').reset(); document.getElementById('edit-id').value = ''; document.getElementById('alat-bantu-list').innerHTML = ''; }
function resetAllData() { if (confirm('APAKAH ANDA YAKIN INGIN MENGHAPUS SEMUA DATA LAPORAN?\n\nTindakan ini tidak dapat dibatalkan.')) { localStorage.removeItem('laporanData_v2'); localStorage.removeItem('lastId_v2'); renderTable(); alert('Semua data laporan telah berhasil dihapus.'); } }

// --- [SCRIPT UNTUK CETAK YANG SUDAH DIPERBAIKI] ---
let movedElements = null;

function prepareAndPrint() {
    const mainTable = document.getElementById('laporan-table');
    const allTbodies = mainTable.querySelectorAll('tbody');
    const footer = document.querySelector('.report-footer');
    const container = document.querySelector('.container');

    // Jika entri kurang dari 3, cetak normal. Tidak ada risiko TTD sendirian.
    if (allTbodies.length < 3) {
        window.print();
        return;
    }

    // 1. Tandai footer ASLI agar disembunyikan saat print.
    footer.classList.add('moved');

    // Ambil 2 entri data terakhir
    const lastTbody = allTbodies[allTbodies.length - 1];
    const secondLastTbody = allTbodies[allTbodies.length - 2];

    // Buat wrapper untuk menggabungkan data terakhir dan TTD
    const wrapper = document.createElement('div');
    wrapper.className = 'last-page-wrapper';

    // Buat tabel baru di dalam wrapper
    const newTable = document.createElement('table');
    const originalThead = mainTable.querySelector('thead');
    if (originalThead) {
        newTable.appendChild(originalThead.cloneNode(true)); // Salin header tabel
    }
    
    // Pindahkan 2 tbody terakhir ke tabel baru
    newTable.appendChild(secondLastTbody);
    newTable.appendChild(lastTbody);
    
    // Masukkan tabel baru ke dalam wrapper
    wrapper.appendChild(newTable);
    
    // 2. Buat KLON/SALINAN dari footer dan masukkan ke dalam wrapper.
    // Inilah perbaikan utamanya. Kita tidak memindahkan yang asli.
    wrapper.appendChild(footer.cloneNode(true));

    // Tambahkan wrapper ke kontainer utama
    container.appendChild(wrapper);
    
    // Simpan referensi elemen untuk proses pembersihan setelah cetak
    movedElements = {
        wrapper,
        footer,
        lastTbody,
        secondLastTbody,
        mainTable
    };
    
    window.print();
}

function cleanupAfterPrint() {
    if (!movedElements) return;

    const { wrapper, footer, lastTbody, secondLastTbody, mainTable } = movedElements;

    // 1. Kembalikan footer ASLI ke status terlihat dengan menghapus kelas 'moved'.
    footer.classList.remove('moved');

    // 2. Kembalikan dua tbody ke tabel utama dalam urutan yang benar.
    mainTable.appendChild(secondLastTbody);
    mainTable.appendChild(lastTbody);
    
    // 3. Hapus wrapper yang berisi elemen kloningan.
    wrapper.remove();

    // Reset variabel global
    movedElements = null;
}

window.addEventListener('afterprint', cleanupAfterPrint);

document.addEventListener('DOMContentLoaded', renderTable);
</script>

</body>
</html>
